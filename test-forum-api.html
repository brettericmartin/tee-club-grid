<!DOCTYPE html>
<html>
<head>
    <title>Test Forum API</title>
</head>
<body>
    <h1>Testing Forum Equipment Integration</h1>
    <div id="results"></div>
    
    <script type="module">
        // Import Supabase client
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
        
        // Get credentials from localStorage (if logged in) or use anon key
        const supabaseUrl = 'https://gylensvamhsgbqytqwrq.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd5bGVuc3ZhbWhzZ2JxeXRxd3JxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjgxNjI3MDAsImV4cCI6MjA0MzczODcwMH0.jibpP2eGdaxWN6v2VjMXFp5A5U6SknTJzPc5QnVHD4Q';
        
        const supabase = createClient(supabaseUrl, supabaseAnonKey);
        const resultsDiv = document.getElementById('results');
        
        async function testForumEquipment() {
            try {
                // 1. Check if forum_equipment_tags table exists
                resultsDiv.innerHTML += '<h2>1. Checking forum_equipment_tags table...</h2>';
                const { data: tags, error: tagsError } = await supabase
                    .from('forum_equipment_tags')
                    .select('*')
                    .limit(5);
                
                if (tagsError) {
                    resultsDiv.innerHTML += `<p style="color: red;">Error: ${tagsError.message}</p>`;
                } else {
                    resultsDiv.innerHTML += `<p style="color: green;">Found ${tags.length} equipment tags</p>`;
                }
                
                // 2. Get some equipment
                resultsDiv.innerHTML += '<h2>2. Getting sample equipment...</h2>';
                const { data: equipment, error: equipError } = await supabase
                    .from('equipment')
                    .select('id, brand, model')
                    .eq('category', 'driver')
                    .limit(1);
                
                if (equipError || !equipment || equipment.length === 0) {
                    resultsDiv.innerHTML += `<p style="color: red;">No equipment found</p>`;
                    return;
                }
                
                const testEquipmentId = equipment[0].id;
                resultsDiv.innerHTML += `<p>Testing with: ${equipment[0].brand} ${equipment[0].model}</p>`;
                
                // 3. Test getForumThreadsByEquipment logic
                resultsDiv.innerHTML += '<h2>3. Testing forum threads query...</h2>';
                
                // Get tagged posts
                const { data: taggedPosts, error: taggedError } = await supabase
                    .from('forum_equipment_tags')
                    .select('post_id')
                    .eq('equipment_id', testEquipmentId);
                
                if (taggedError) {
                    resultsDiv.innerHTML += `<p style="color: red;">Error getting tags: ${taggedError.message}</p>`;
                } else if (!taggedPosts || taggedPosts.length === 0) {
                    resultsDiv.innerHTML += `<p style="color: orange;">No forum posts tagged with this equipment</p>`;
                } else {
                    resultsDiv.innerHTML += `<p style="color: green;">Found ${taggedPosts.length} tagged posts</p>`;
                    
                    // Get threads
                    const { data: posts, error: postsError } = await supabase
                        .from('forum_posts')
                        .select('thread_id')
                        .in('id', taggedPosts.map(t => t.post_id));
                    
                    if (postsError) {
                        resultsDiv.innerHTML += `<p style="color: red;">Error getting posts: ${postsError.message}</p>`;
                    } else {
                        const threadIds = [...new Set(posts.map(p => p.thread_id))];
                        resultsDiv.innerHTML += `<p style="color: green;">Found ${threadIds.length} threads</p>`;
                    }
                }
                
                // 4. Check forum_threads tee_count column
                resultsDiv.innerHTML += '<h2>4. Checking tee_count column...</h2>';
                const { data: threadsWithTeeCount, error: teeError } = await supabase
                    .from('forum_threads')
                    .select('id, title, tee_count')
                    .limit(1);
                
                if (teeError) {
                    resultsDiv.innerHTML += `<p style="color: red;">Error: ${teeError.message}</p>`;
                    resultsDiv.innerHTML += '<p style="color: orange;">You may need to run the migration to add tee_count column</p>';
                } else {
                    resultsDiv.innerHTML += `<p style="color: green;">tee_count column exists</p>`;
                }
                
            } catch (error) {
                resultsDiv.innerHTML += `<p style="color: red;">Unexpected error: ${error.message}</p>`;
            }
        }
        
        testForumEquipment();
    </script>
</body>
</html>